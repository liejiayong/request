{"version":3,"file":"request.global.js","sources":["../lib/index.ts"],"sourcesContent":["/**\n * @author liejiayong (809206619@qq.com)\n * @Date: 2022-07-01 14：34：45\n * @LastEditTime: 2022-08-04 18:29:28\n * @LastEditors: liejiayong(809206619@qq.com)\n * @Description: In User Settings Edit\n */\nimport axios from \"axios\";\nimport type { AxiosInstance, AxiosResponse, AxiosRequestConfig } from \"axios\";\n\nexport interface ResponseConfig extends AxiosResponse {\n  is2Catch?: boolean /* 用于手动拦截ResponseConfig触发catch时使用 */;\n}\nexport interface RequestInterceptors<\n  Req = AxiosRequestConfig,\n  Res = ResponseConfig\n> {\n  requestInterceptors?: (config: Req) => Req;\n  requestInterceptorsCatch?: (err: any) => any;\n\n  responseInterceptors?: (config: Res) => Res;\n  responseInterceptorsCatch?: (err: any) => any;\n}\n\ntype codeType =  string | number | boolean\nexport type SuccessMaps = Record<string, codeType| codeType[]>;\n\nexport interface RequestConfig extends AxiosRequestConfig {\n  interceptors?: RequestInterceptors;\n  successMap?: SuccessMaps;\n  canRepeat?: boolean;\n}\n\nexport interface CancelRequestSource {\n  [index: string]: () => void;\n}\n\nconst isBoolean = (val: unknown) =>\n  Object.prototype.toString.call(val) === \"[object Boolean]\";\n\nconst isArray = (val: unknown) =>\n  Object.prototype.toString.call(val) === \"[object Array]\";\n\nfunction getSuccessFlag(raw: SuccessMaps = {}, ref: SuccessMaps = {}) {\n  let flag = false;\n  for (const key in ref) {\n    const v1 = raw[key]\n    const v2 = ref[key]\n    const state = isArray(v2) ? (v2 as codeType[]).some(item => v1 === item) : v1 === v2\n    if (state) {\n      flag = true;\n    }\n  }\n  return flag;\n}\n\nclass Request {\n  instance: AxiosInstance;\n\n  interceptorsObj?: RequestInterceptors<RequestConfig, ResponseConfig>;\n\n  cancelRequestSourceList: CancelRequestSource[];\n\n  requestUrlList: string[];\n\n  successMap: SuccessMaps;\n\n  constructor(config: RequestConfig) {\n    this.instance = axios.create(config);\n    this.interceptorsObj = config.interceptors;\n    this.requestUrlList = [];\n    this.successMap = config.successMap || {};\n    this.cancelRequestSourceList = [];\n    this.instance.interceptors.request.use(\n      (res: RequestConfig) => res,\n      (err: any) => err\n    );\n    this.instance.interceptors.request.use(\n      this.interceptorsObj?.requestInterceptors,\n      this.interceptorsObj?.requestInterceptorsCatch\n    );\n    this.instance.interceptors.response.use(\n      this.interceptorsObj?.responseInterceptors,\n      this.interceptorsObj?.responseInterceptorsCatch\n    );\n    this.instance.interceptors.response.use(\n      (res) => res,\n      (err: any) => err\n    );\n  }\n\n  request<T = any>(config: RequestConfig): Promise<T> {\n    return new Promise((resolve, reject) => {\n      config.canRepeat = isBoolean(config.canRepeat) ? config.canRepeat : true;\n      if (config.interceptors?.requestInterceptors) {\n        config = config.interceptors.requestInterceptors(config);\n      }\n      const { url, canRepeat } = config;\n      if (!canRepeat && url) {\n        this.requestUrlList?.push(url);\n        config.cancelToken = new axios.CancelToken((c) => {\n          this.cancelRequestSourceList?.push({\n            [url]: c,\n          });\n        });\n      }\n      this.instance\n        .request<any, ResponseConfig>(config)\n        .then((res) => {\n          if (config.interceptors?.responseInterceptors) {\n            res = config.interceptors.responseInterceptors(res);\n          }\n          if (res.status === 200) {\n            if (JSON.stringify(this.successMap) !== \"{}\") {\n              if (getSuccessFlag(res.data, this.successMap)) {\n                resolve(res.data);\n              } else {\n                reject(res.data);\n              }\n            } else {\n              resolve(res.data);\n            }\n          } else {\n            reject(res.data);\n          }\n        })\n        .catch((err: any) => {\n          reject(err);\n        })\n        .finally(() => {\n          url && this.delUrl(url);\n        });\n    });\n  }\n\n  private getSourceIndex(url: string): number {\n    return this.cancelRequestSourceList?.findIndex(\n      (item: CancelRequestSource) => Object.keys(item)[0] === url\n    ) as number;\n  }\n\n  private delUrl(url: string) {\n    const urlIndex = this.requestUrlList?.findIndex((u) => u === url);\n    const sourceIndex = this.getSourceIndex(url);\n    urlIndex !== -1 && this.requestUrlList?.splice(urlIndex as number, 1);\n    sourceIndex !== -1 &&\n      this.cancelRequestSourceList?.splice(sourceIndex as number, 1);\n  }\n\n  cancelAllRequest() {\n    this.cancelRequestSourceList?.forEach((source) => {\n      const key = Object.keys(source)[0];\n      source[key]();\n    });\n  }\n\n  cancelRequest(url: string | string[]) {\n    if (typeof url === \"string\") {\n      const sourceIndex = this.getSourceIndex(url);\n      sourceIndex >= 0 && this.cancelRequestSourceList?.[sourceIndex][url]();\n    } else {\n      url.forEach((u) => {\n        const sourceIndex = this.getSourceIndex(u);\n        sourceIndex >= 0 && this.cancelRequestSourceList?.[sourceIndex][u]();\n      });\n    }\n  }\n}\n\nexport default Request;\n"],"names":["axios"],"mappings":"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"}